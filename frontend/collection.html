<!-- collection.html (FULL UPDATED v2 - Vehicle details + save to DB if columns exist, else fallback) -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Collection - Smart Waste ERP</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>
<div class="container">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="brand">Smart Waste ERP</div>

    <div class="nav">
      <a class="nav-all" href="dashboard.html">üè† Dashboard</a>
      <a class="nav-all" href="map.html">üìç View Live Location</a>

      <a class="nav-admin" href="users.html">üë• Users</a>

      <a class="nav-worker nav-driver nav-recycling nav-admin" href="tasks.html">üìã My Tasks</a>

      <a class="nav-worker nav-driver nav-admin active" href="collection.html">üóëÔ∏è Collection</a>
      <a class="nav-worker nav-driver nav-admin" href="bins.html">üß∫ Bin Status</a>
      <a class="nav-worker nav-driver nav-admin" href="staff_vehicle.html">üöõ Staff & Vehicle</a>

      <a class="nav-recycling nav-admin" href="recycling.html">‚ôªÔ∏è Recycling</a>

      <a class="nav-worker nav-driver nav-recycling nav-admin" href="report.html">üìä Reports</a>

      <a class="nav-admin nav-worker nav-driver" href="complaints.html">üìù Complaints</a>
    </div>

    <button type="button" class="btn red" id="logoutBtnSidebar">Logout</button>
  </aside>

  <!-- MAIN -->
  <main class="main">

    <!-- TOPBAR -->
    <div class="topbar">
      <div class="topbar-left">
        <h1 id="pageTitle">Waste Collection</h1>
        <p class="sub" id="pageSub">Add collection records. Link Pickup Task ID or Trip Task ID.</p>
      </div>

      <div class="topbar-right" style="display:flex; gap:10px; align-items:center;">
        <a href="profile.html" title="My Profile">
          <img
            src="https://cdn-icons-png.flaticon.com/512/847/847969.png"
            class="profile-icon"
            alt="Profile"
            style="cursor:pointer;"
          />
        </a>

        <button type="button" class="btn red" id="logoutBtnTop">Logout</button>
      </div>
    </div>

    <!-- Form Card -->
    <div class="card">
      <h2 style="margin-top:0;">New Collection Entry</h2>

      <div class="form">
        <div>
          <div class="label">Date</div>
          <input type="date" id="date">
        </div>

        <div>
          <div class="label">Area</div>
          <input type="text" id="area" placeholder="Eg: Gandhipuram">
        </div>

        <div>
          <div class="label">Waste Type</div>
          <select id="type">
            <option>Wet</option>
            <option>Dry</option>
            <option>Plastic</option>
          </select>
        </div>

        <div>
          <div class="label">Quantity (kg)</div>
          <input type="number" id="qty" placeholder="Eg: 25" min="0" step="0.01">
        </div>

        <!-- ‚úÖ NEW: Vehicle details -->
        <div>
          <div class="label">Vehicle ID (optional)</div>
          <input type="text" id="vehicleId" placeholder="Eg: TN-37-WM-1023">
          <div class="sub" style="margin-top:6px; opacity:.85;">
            If DB has <b>vehicle_id</b> column, it will be saved. Otherwise it will stay as reference only.
          </div>
        </div>

        <!-- ‚úÖ UI-only Bin reference (not saved unless column exists) -->
        <div>
          <div class="label">Bin ID (optional)</div>
          <input type="text" id="binId" placeholder="Eg: B001">
          <div class="sub" style="margin-top:6px; opacity:.85;">
            Saved only if your table has <b>bin_id</b> column. Otherwise reference only.
          </div>
        </div>

        <div class="full">
          <div class="label">Pickup Task ID (for pickup flow)</div>
          <input type="text" id="taskId" placeholder="Auto-filled from My Tasks / Bin Status">
          <div class="sub" style="margin-top:6px; opacity:.85;">
            Pickup flow: links the collection record to <b>pickup_tasks.id</b>.
          </div>
        </div>

        <div class="full">
          <div class="label">Trip Staff Task ID (auto from Trip completion)</div>
          <input type="text" id="staffTaskId" placeholder="Auto-filled when you complete a Trip">
          <div class="sub" style="margin-top:6px; opacity:.85;">
            Trip flow: completing Trip redirects here and auto-fills this ID.
          </div>
        </div>

        <div class="full" style="display:flex; gap:10px; flex-wrap:wrap;">
          <button type="button" class="btn" id="saveCollectionBtn">Save Collection</button>
          <button type="button" class="btn" id="goStaffVehicleBtn" style="opacity:.9;">Go to Staff & Vehicle</button>
        </div>
      </div>
    </div>

    <!-- Saved Records -->
    <div class="card" style="margin-top:14px;">
      <div style="display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:10px;">
        <h2 style="margin:0;">Saved Records</h2>
        <input id="searchCollections" placeholder="Search area/type/date/task/vehicle...">
      </div>

      <table class="table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Area</th>
            <th>Type</th>
            <th>Qty (kg)</th>
            <th>Vehicle</th>
            <th>Bin</th>
            <th>Pickup Task ID</th>
            <th>Trip Task ID</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="collectionsBody">
          <tr><td colspan="9" style="opacity:.8;">Loading...</td></tr>
        </tbody>
      </table>
    </div>

  </main>
</div>

<div class="toast" id="toast"></div>

<!-- app.js must set window.supabase + window.toast + protectPage + applyRoleMenu -->
<script type="module" src="./app.js"></script>

<script type="module">
  const $ = (id) => document.getElementById(id);

  function todayISO() {
    const d = new Date();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${d.getFullYear()}-${mm}-${dd}`;
  }

  function getSB() {
    return window.supabase || null;
  }

  function toast(msg, ok = true) {
    if (window.toast) return window.toast(msg);
    const el = $("toast");
    if (!el) return alert(msg);
    el.textContent = msg;
    el.style.display = "block";
    el.style.borderColor = ok ? "" : "rgba(255,80,80,.55)";
    el.style.background = ok ? "" : "rgba(255,80,80,.12)";
    clearTimeout(window.__t);
    window.__t = setTimeout(() => (el.style.display = "none"), 2200);
  }

  async function ensureAuth() {
    window.applyRoleMenu?.();
    const ok = await window.protectPage?.(["admin","worker","driver"]);
    if (!ok) return false;
    window.setActiveNav?.();
    window.initProfileMenu?.();
    return true;
  }

  // ‚úÖ Try insert; if DB doesn't have bin_id / vehicle_id columns, fallback without them
  async function safeInsertCollection(sb, payloadFull, payloadFallback) {
    let r1 = await sb.from("collection_records").insert([payloadFull]);
    if (!r1.error) return { ok: true, usedFallback: false };

    const msg = (r1.error.message || "").toLowerCase();
    if (msg.includes("column") && msg.includes("does not exist")) {
      const r2 = await sb.from("collection_records").insert([payloadFallback]);
      if (r2.error) return { ok: false, error: r2.error.message };
      return { ok: true, usedFallback: true };
    }

    return { ok: false, error: r1.error.message };
  }

  // ‚úÖ AUTO-FILL: task_id + staff_task_id + area + bin_id + vehicle_id from URL + fetch if missing
  async function autofillFromUrl() {
    const sb = getSB();
    const sp = new URLSearchParams(window.location.search);

    const task_id = (sp.get("task_id") || "").trim();
    const staff_task_id = (sp.get("staff_task_id") || "").trim();
    const areaFromUrl = (sp.get("area") || "").trim();
    const binFromUrl = (sp.get("bin_id") || sp.get("binId") || "").trim();
    const vehicleFromUrl = (sp.get("vehicle_id") || sp.get("vehicleId") || "").trim();

    if (task_id && $("taskId")) $("taskId").value = task_id;
    if (staff_task_id && $("staffTaskId")) $("staffTaskId").value = staff_task_id;

    if (areaFromUrl && $("area") && !$("area").value) $("area").value = areaFromUrl;
    if (binFromUrl && $("binId") && !$("binId").value) $("binId").value = binFromUrl;
    if (vehicleFromUrl && $("vehicleId") && !$("vehicleId").value) $("vehicleId").value = vehicleFromUrl;

    // If coming from pickup task and area/bin missing -> fetch from pickup_tasks
    if (task_id && sb) {
      try {
        const { data, error } = await sb
          .from("pickup_tasks")
          .select("area,bin_id")
          .eq("id", task_id)
          .maybeSingle();

        if (!error && data) {
          if ($("area") && !$("area").value && data.area) $("area").value = data.area;
          if ($("binId") && !$("binId").value && data.bin_id) $("binId").value = data.bin_id;
        }
      } catch {}
    }

    // If coming from trip task and area/vehicle missing -> fetch from staff_tasks
    if (staff_task_id && sb) {
      try {
        const { data, error } = await sb
          .from("staff_tasks")
          .select("route,vehicle_id")
          .eq("id", staff_task_id)
          .maybeSingle();

        if (!error && data) {
          if ($("area") && !$("area").value && data.route) $("area").value = data.route;
          if ($("vehicleId") && !$("vehicleId").value && data.vehicle_id) $("vehicleId").value = data.vehicle_id;
        }
      } catch {}
    }

    if (task_id || staff_task_id) toast("Auto-filled from task ‚úÖ");
  }

  function esc(s) {
    return String(s ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  async function renderCollections() {
    const sb = getSB();
    const body = $("collectionsBody");
    if (!sb) {
      body.innerHTML = `<tr><td colspan="9" style="opacity:.85;">Supabase not found. app.js must set window.supabase</td></tr>`;
      return;
    }

    const q = ($("searchCollections")?.value || "").trim().toLowerCase();

    const { data: sess } = await sb.auth.getSession();
    const session = sess?.session;
    if (!session) return;

    // We try selecting optional columns; if they don't exist, fallback select.
    const selectFull = "id,date,area,waste_type,quantity_kg,task_id,staff_task_id,vehicle_id,bin_id,created_at";
    let rows = [];

    {
      const r1 = await sb
        .from("collection_records")
        .select(selectFull)
        .eq("user_id", session.user.id)
        .order("created_at", { ascending: false })
        .limit(300);

      if (!r1.error) {
        rows = r1.data || [];
      } else {
        const msg = (r1.error.message || "").toLowerCase();
        if (msg.includes("column") && msg.includes("does not exist")) {
          const r2 = await sb
            .from("collection_records")
            .select("id,date,area,waste_type,quantity_kg,task_id,staff_task_id,created_at")
            .eq("user_id", session.user.id)
            .order("created_at", { ascending: false })
            .limit(300);

          if (r2.error) {
            console.log("renderCollections error:", r2.error);
            body.innerHTML = `<tr><td colspan="9" style="opacity:.85;">${esc(r2.error.message)}</td></tr>`;
            return;
          }
          rows = r2.data || [];
        } else {
          console.log("renderCollections error:", r1.error);
          body.innerHTML = `<tr><td colspan="9" style="opacity:.85;">${esc(r1.error.message)}</td></tr>`;
          return;
        }
      }
    }

    const filtered = (rows || []).filter(r => {
      if (!q) return true;
      const hay = `${r.date||""} ${r.area||""} ${r.waste_type||""} ${r.quantity_kg||""} ${r.task_id||""} ${r.staff_task_id||""} ${r.vehicle_id||""} ${r.bin_id||""}`.toLowerCase();
      return hay.includes(q);
    });

    if (!filtered.length) {
      body.innerHTML = `<tr><td colspan="9" style="opacity:.8;">No records found.</td></tr>`;
      return;
    }

    body.innerHTML = filtered.map(r => `
      <tr>
        <td>${esc(r.date ?? "-")}</td>
        <td>${esc(r.area ?? "-")}</td>
        <td>${esc(r.waste_type ?? "-")}</td>
        <td>${esc(r.quantity_kg ?? "-")}</td>
        <td>${esc(r.vehicle_id ?? "-")}</td>
        <td>${esc(r.bin_id ?? "-")}</td>
        <td style="max-width:220px; word-break:break-all;">${esc(r.task_id ?? "-")}</td>
        <td style="max-width:220px; word-break:break-all;">${esc(r.staff_task_id ?? "-")}</td>
        <td><button class="btn red" style="padding:6px 10px;" data-del="${esc(r.id)}">Delete</button></td>
      </tr>
    `).join("");

    body.querySelectorAll("[data-del]").forEach(btn => {
      btn.addEventListener("click", () => deleteCollection(btn.getAttribute("data-del")));
    });
  }

  async function deleteCollection(id) {
    const sb = getSB();
    if (!sb) return;

    const yes = confirm("Delete this record?");
    if (!yes) return;

    const { data: sess } = await sb.auth.getSession();
    const session = sess?.session;
    if (!session) return;

    const { error } = await sb
      .from("collection_records")
      .delete()
      .eq("id", id)
      .eq("user_id", session.user.id);

    if (error) {
      console.log("delete error:", error);
      return toast("Delete failed: " + error.message, false);
    }

    toast("Deleted ‚úÖ");
    await renderCollections();
  }

  async function saveCollection() {
    const sb = getSB();
    if (!sb) return toast("Supabase not found (app.js must set window.supabase)", false);

    if (window.__savingCollection) return;
    window.__savingCollection = true;

    const btn = $("saveCollectionBtn");
    const oldText = btn.textContent;
    btn.textContent = "Saving...";
    btn.disabled = true;

    try {
      const { data: sess } = await sb.auth.getSession();
      const session = sess?.session;
      if (!session) {
        toast("Login required", false);
        window.location = "index.html";
        return;
      }

      const date = $("date")?.value || todayISO();
      const area = ($("area")?.value || "").trim();
      const waste_type = $("type")?.value;
      const quantity_kg = Number($("qty")?.value);

      const vehicle_id = ($("vehicleId")?.value || "").trim() || null;
      const bin_id = ($("binId")?.value || "").trim() || null;

      const task_id = ($("taskId")?.value || "").trim() || null;
      const staff_task_id = ($("staffTaskId")?.value || "").trim() || null;

      if (!area) { toast("Area is required.", false); return; }
      if (!Number.isFinite(quantity_kg) || quantity_kg <= 0) { toast("Quantity must be > 0.", false); return; }

      // Full payload (includes optional columns)
      const payloadFull = {
        user_id: session.user.id,
        date,
        area,
        waste_type,
        quantity_kg,
        task_id,
        staff_task_id,
        vehicle_id,
        bin_id
      };

      // Fallback payload (only guaranteed columns)
      const payloadFallback = {
        user_id: session.user.id,
        date,
        area,
        waste_type,
        quantity_kg,
        task_id,
        staff_task_id
      };

      const r = await safeInsertCollection(sb, payloadFull, payloadFallback);
      if (!r.ok) {
        toast("Save failed: " + r.error, false);
        return;
      }

      toast(r.usedFallback
        ? "Collection saved ‚úÖ (vehicle/bin not saved because DB columns not found)"
        : "Collection saved ‚úÖ"
      );

      if ($("qty")) $("qty").value = "";
      await renderCollections();

    } finally {
      window.__savingCollection = false;
      btn.textContent = oldText;
      btn.disabled = false;
    }
  }

  window.addEventListener("DOMContentLoaded", async () => {
    const ok = await ensureAuth();
    if (!ok) return;

    if (!$("date")?.value) $("date").value = todayISO();

    await autofillFromUrl();

    $("saveCollectionBtn")?.addEventListener("click", saveCollection);
    $("goStaffVehicleBtn")?.addEventListener("click", () => (window.location.href = "staff_vehicle.html"));
    $("searchCollections")?.addEventListener("input", renderCollections);

    $("logoutBtnTop")?.addEventListener("click", () => window.logout?.());
    $("logoutBtnSidebar")?.addEventListener("click", () => window.logout?.());

    await renderCollections();
  });
</script>

</body>
</html>