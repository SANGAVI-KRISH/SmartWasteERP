<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reports - Smart Waste ERP</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>
<div class="container">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="brand">Smart Waste ERP</div>

    <div class="nav">
      <!-- All roles -->
      <a class="nav-all" href="dashboard.html">ğŸ  Dashboard</a>
      <a class="nav-all" href="map.html">ğŸ“ View Live Location</a>

      <!-- Admin only -->
      <a class="nav-admin" href="users.html">ğŸ‘¥ Users</a>

      <!-- Worker + Driver + Recycling Manager + Admin -->
      <a class="nav-worker nav-driver nav-recycling nav-admin" href="tasks.html">ğŸ“‹ My Tasks</a>

      <!-- Worker + Driver + Admin -->
      <a class="nav-worker nav-driver nav-admin" href="collection.html">ğŸ—‘ï¸ Collection</a>
      <a class="nav-worker nav-driver nav-admin" href="bins.html">ğŸ§º Bin Status</a>
      <a class="nav-worker nav-driver nav-admin" href="staff_vehicle.html">ğŸš› Staff & Vehicle</a>

      <!-- Recycling Manager + Admin -->
      <a class="nav-recycling nav-admin" href="recycling.html">â™»ï¸ Recycling</a>

      <!-- Worker + Driver + Recycling Manager + Admin -->
      <a class="nav-worker nav-driver nav-recycling nav-admin" href="report.html">ğŸ“Š Reports</a>

      <!-- Complaints -->
      <a class="nav-admin nav-worker nav-driver" href="complaints.html">ğŸ“ Complaints</a>
    </div>

    <button type="button" class="btn red" id="logoutBtnSidebar">Logout</button>
  </aside>

  <!-- MAIN -->
  <main class="main">

    <!-- TOPBAR -->
    <div class="topbar">
      <div class="topbar-left">
        <h1 id="pageTitle">Reports</h1>
        <p class="sub" id="pageSub">Auto-generated summary from Collection, Bin and Recycling data.</p>
      </div>

      <div class="topbar-right" style="display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button type="button" class="btn" id="refreshBtn">Refresh</button>
          <button type="button" class="btn" id="exportBtn">Export CSV</button>
        </div>

        <a href="profile.html" title="My Profile">
          <img
            src="https://cdn-icons-png.flaticon.com/512/847/847969.png"
            class="profile-icon"
            alt="Profile"
            style="cursor:pointer;"
          />
        </a>

        <button type="button" class="btn red" id="logoutBtnTop">Logout</button>
      </div>
    </div>

    <!-- KPI Cards -->
    <div class="grid">
      <div class="card">
        <div class="label">Total Collected</div>
        <div class="value" id="kpiTotalCollected">0 kg</div>
      </div>
      <div class="card">
        <div class="label">Total Recycled</div>
        <div class="value" id="kpiTotalRecycled">0 kg</div>
      </div>
      <div class="card">
        <div class="label">Sent to Landfill</div>
        <div class="value" id="kpiTotalLandfill">0 kg</div>
      </div>
    </div>

    <div class="grid" style="margin-top:14px;">
      <div class="card">
        <div class="label">Full Bins (Priority)</div>
        <div class="value" id="kpiFullBins">0</div>
      </div>
      <div class="card">
        <div class="label">Collection Records</div>
        <div class="value" id="kpiCollectionCount">0</div>
      </div>
      <div class="card">
        <div class="label">Recycling Records</div>
        <div class="value" id="kpiRecyclingCount">0</div>
      </div>
    </div>

    <!-- Breakdown -->
    <div class="card" style="margin-top:14px;">
      <div style="display:flex; align-items:flex-end; justify-content:space-between; gap:12px; margin-bottom:10px;">
        <div>
          <h2 style="margin:0;">Collected Waste by Type</h2>
          <p class="sub" style="margin:6px 0 0;">(Wet / Dry / Plastic)</p>
        </div>
      </div>

      <!-- Simple Bars -->
      <div id="barChart" style="display:grid; gap:10px;"></div>

      <div style="height:12px;"></div>

      <table class="table">
        <thead>
          <tr>
            <th>Waste Type</th>
            <th>Total Collected (kg)</th>
          </tr>
        </thead>
        <tbody id="typeBreakdownBody"></tbody>
      </table>
    </div>

    <!-- Operational Insight -->
    <div class="card" style="margin-top:14px;">
      <h2 style="margin-top:0;">Operational Insight</h2>
      <p class="sub" id="insightText" style="margin-bottom:0;">
        Click Refresh to generate insights.
      </p>
    </div>

  </main>
</div>

<div class="toast" id="toast"></div>

<!-- Global app.js (auth/menu utilities) -->
<script type="module" src="app.js"></script>

<!-- Reports engine -->
<script type="module">
  const getSupabase = async () => {
    if (window.supabase) return window.supabase;
    throw new Error("Supabase client not found. Ensure app.js sets window.supabase");
  };

  const fmtKg = (n) => `${Math.round(Number(n) || 0)} kg`;

  // Normalize waste type
  function normType(t) {
    const s = String(t || "").trim().toLowerCase();
    if (!s) return "unknown";
    if (s.includes("wet")) return "wet";
    if (s.includes("dry")) return "dry";
    if (s.includes("plastic")) return "plastic";
    return s;
  }

  function isBinFull(b) {
    const s = String(b.status || "").toLowerCase();
    return s.includes("full") || s.includes("overflow") || s.includes("100");
  }

  // Render bars
  function renderBars(typeTotals) {
    const barChart = document.getElementById("barChart");
    barChart.innerHTML = "";

    const entries = Object.entries(typeTotals);
    const maxVal = Math.max(1, ...entries.map(([, v]) => v));

    entries.forEach(([type, val]) => {
      const pct = Math.round((val / maxVal) * 100);

      const row = document.createElement("div");
      row.style.display = "grid";
      row.style.gridTemplateColumns = "120px 1fr 80px";
      row.style.alignItems = "center";
      row.style.gap = "10px";

      const label = document.createElement("div");
      label.textContent = type.toUpperCase();

      const barWrap = document.createElement("div");
      barWrap.style.height = "12px";
      barWrap.style.borderRadius = "999px";
      barWrap.style.background = "rgba(255,255,255,0.08)";
      barWrap.style.overflow = "hidden";

      const bar = document.createElement("div");
      bar.style.height = "100%";
      bar.style.width = pct + "%";
      bar.style.borderRadius = "999px";
      bar.style.background = "rgba(90, 152, 255, 0.9)";

      barWrap.appendChild(bar);

      const value = document.createElement("div");
      value.style.textAlign = "right";
      value.textContent = fmtKg(val);

      row.appendChild(label);
      row.appendChild(barWrap);
      row.appendChild(value);

      barChart.appendChild(row);
    });
  }

  // Render type breakdown table
  function renderTypeTable(typeTotals) {
    const body = document.getElementById("typeBreakdownBody");
    body.innerHTML = "";

    const entries = Object.entries(typeTotals).sort((a, b) => b[1] - a[1]);

    if (!entries.length) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>(no data)</td><td></td>`;
      body.appendChild(tr);
      return;
    }

    entries.forEach(([type, val]) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${type.toUpperCase()}</td><td>${fmtKg(val)}</td>`;
      body.appendChild(tr);
    });
  }

  // âœ… Main report function
  async function generateReport() {
    const supabase = await getSupabase();

    // âœ… FIXED TABLE NAMES (from your app.js)
    const [{ data: collection, error: cErr },
           { data: bins, error: bErr },
           { data: recycling, error: rErr }] = await Promise.all([
      supabase.from("collection_records").select("waste_type, quantity_kg"),
      supabase.from("bins").select("status"),
      supabase.from("recycling").select("waste_type, input_kg, recycled_kg, landfill_kg"),
    ]);

    if (cErr) throw cErr;
    if (bErr) throw bErr;
    if (rErr) throw rErr;

    // âœ… TOTALS
    const totalCollected = (collection || []).reduce((sum, r) => sum + (Number(r.quantity_kg) || 0), 0);
    const totalRecycled = (recycling || []).reduce((sum, r) => sum + (Number(r.recycled_kg) || 0), 0);

    // Use landfill_kg from table if available, else collected - recycled
    const landfillFromTable = (recycling || []).reduce((sum, r) => sum + (Number(r.landfill_kg) || 0), 0);
    const landfill = landfillFromTable > 0 ? landfillFromTable : Math.max(0, totalCollected - totalRecycled);

    const fullBins = (bins || []).filter(isBinFull).length;

    // âœ… TYPE TOTALS (from collection_records)
    const typeTotals = { wet: 0, dry: 0, plastic: 0 };
    (collection || []).forEach(r => {
      const t = normType(r.waste_type);
      const w = Number(r.quantity_kg) || 0;
      if (!typeTotals[t]) typeTotals[t] = 0;
      typeTotals[t] += w;
    });

    // âœ… UPDATE KPIs
    document.getElementById("kpiTotalCollected").textContent = fmtKg(totalCollected);
    document.getElementById("kpiTotalRecycled").textContent = fmtKg(totalRecycled);
    document.getElementById("kpiTotalLandfill").textContent = fmtKg(landfill);

    document.getElementById("kpiFullBins").textContent = String(fullBins);
    document.getElementById("kpiCollectionCount").textContent = String((collection || []).length);
    document.getElementById("kpiRecyclingCount").textContent = String((recycling || []).length);

    // âœ… RENDER BREAKDOWN
    renderBars(typeTotals);
    renderTypeTable(typeTotals);

    // âœ… INSIGHT
    const rate = totalCollected > 0 ? ((totalRecycled / totalCollected) * 100).toFixed(1) : "0.0";
    let msg = `Recycling Efficiency: ${rate}% of collected waste is recycled. `;

    if (fullBins > 0) msg += `Priority Alert: ${fullBins} bin(s) are FULL and need pickup. `;
    msg += `Landfill waste: ${fmtKg(landfill)}.`;

    document.getElementById("insightText").textContent = msg.trim();
  }

  // CSV export helpers
  function csvEscape(v) {
    const s = String(v ?? "");
    if (/[",\n]/.test(s)) return `"${s.replace(/"/g, '""')}"`;
    return s;
  }

  function downloadCSV(filename, rows) {
    const csv = rows.map(r => r.map(csvEscape).join(",")).join("\n");
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function collectTypeTableRows() {
    const rows = [];
    document.querySelectorAll("#typeBreakdownBody tr").forEach(tr => {
      const tds = tr.querySelectorAll("td");
      if (tds.length >= 2) rows.push([tds[0].textContent, tds[1].textContent]);
    });
    return rows;
  }

  // expose globally
  window.generateReport = generateReport;

  window.addEventListener("DOMContentLoaded", async () => {
    window.applyRoleMenu?.();

    const ok = await window.protectPage?.(["admin","worker","driver","recycling_manager"]);
    if (!ok) return;

    window.setActiveNav?.();

    // logout buttons
    document.getElementById("logoutBtnTop")?.addEventListener("click", () => window.logout());
    document.getElementById("logoutBtnSidebar")?.addEventListener("click", () => window.logout());

    // refresh button
    document.getElementById("refreshBtn")?.addEventListener("click", async () => {
      try {
        await generateReport();
        window.toast?.("Report updated");
      } catch (e) {
        console.error(e);
        window.toast?.(e.message || "Failed to load report");
      }
    });

    // export csv
    document.getElementById("exportBtn")?.addEventListener("click", () => {
      const now = new Date();
      const filename = `smart_waste_report_${now.toISOString().slice(0,10)}.csv`;

      const rows = [];

      rows.push(["KPI", "Value"]);
      rows.push(["Total Collected", document.getElementById("kpiTotalCollected")?.textContent || ""]);
      rows.push(["Total Recycled", document.getElementById("kpiTotalRecycled")?.textContent || ""]);
      rows.push(["Sent to Landfill", document.getElementById("kpiTotalLandfill")?.textContent || ""]);
      rows.push(["Full Bins", document.getElementById("kpiFullBins")?.textContent || ""]);
      rows.push(["Collection Records", document.getElementById("kpiCollectionCount")?.textContent || ""]);
      rows.push(["Recycling Records", document.getElementById("kpiRecyclingCount")?.textContent || ""]);
      rows.push([]);

      rows.push(["Waste Type", "Total Collected (kg)"]);
      const typeRows = collectTypeTableRows();
      if (typeRows.length) rows.push(...typeRows);
      else rows.push(["(no data)", ""]);

      rows.push([]);
      rows.push(["Insight", document.getElementById("insightText")?.textContent || ""]);

      downloadCSV(filename, rows);
    });

    // auto run on load
    try {
      await generateReport();
    } catch (e) {
      console.error(e);
      window.toast?.(e.message || "Failed to load report");
    }

    // auto refresh every 20 seconds
    setInterval(async () => {
      try { await generateReport(); } catch {}
    }, 20000);
  });
</script>

</body>
</html>